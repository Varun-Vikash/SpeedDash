<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Jazz 1200 Ultimate (Spotify)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- CORE STYLES --- */
        body { font-family: 'Rajdhani', sans-serif; background-color: #050505; overflow: hidden; touch-action: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        .gauge-transition { transition: stroke-dashoffset 0.1s linear; }
        
        /* --- ANIMATIONS --- */
        @keyframes circleExpand {
            0% { clip-path: circle(0% at 50% 50%); }
            100% { clip-path: circle(150% at 50% 50%); }
        }
        .anim-bg-reveal { animation: circleExpand 1.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; }

        @keyframes ecoEnter {
            0% { transform: translateY(50px) scale(0.9); opacity: 0; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }
        .anim-eco-enter { animation: ecoEnter 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

        @keyframes introTextSequence {
            0% { color: white; }
            10% { color: #dc2626; }
            20% { color: white; }
            30% { color: white; }
            40% { color: #dc2626; }
            50% { color: white; }
            100% { color: white; }
        }
        .anim-text-strobe { animation: introTextSequence 0.8s steps(1) forwards; }

        /* MUSIC BARS ANIMATION */
        @keyframes sound-bar {
            0% { height: 10%; }
            50% { height: 100%; }
            100% { height: 10%; }
        }
        .music-bar {
            width: 3px;
            background: #1ed760; /* Spotify Green */
            animation: sound-bar 0.5s infinite ease-in-out;
            border-radius: 2px;
        }
        .music-bar:nth-child(1) { animation-duration: 0.4s; }
        .music-bar:nth-child(2) { animation-duration: 0.5s; }
        .music-bar:nth-child(3) { animation-duration: 0.3s; }
        .music-bar:nth-child(4) { animation-duration: 0.6s; }

        .scanlines {
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 50;
            opacity: 0.3;
        }

        /* --- FL5 SPORT STYLES --- */
        .font-fl5 { font-family: 'Orbitron', sans-serif; letter-spacing: -0.05em; }
        
        .bg-fl5-pattern {
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M20 0l17.32 10v20L20 40 2.68 30V10z' fill-opacity='0.08' fill='%23333' stroke='%23444' stroke-width='1'/%3E%3C/svg%3E");
        }

        /* Shift LEDs */
        .led { width: 100%; height: 8px; background: #333; skew-x: -20deg; border-radius: 2px; transition: background 0.05s, box-shadow 0.05s; }
        .led.green.on { background: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .led.yellow.on { background: #eab308; box-shadow: 0 0 10px #eab308; }
        .led.red.on { background: #ef4444; box-shadow: 0 0 15px #ef4444; }
        .led.blink { animation: flashWhite 0.1s infinite alternate; }

        @keyframes flashWhite { from { background: #ef4444; box-shadow: 0 0 15px #ef4444; } to { background: #ffffff; box-shadow: 0 0 20px #ffffff; } }

        .g-dot-smooth { transition: transform 0.2s cubic-bezier(0.1, 0.7, 1.0, 0.1); }
        
        .hidden-force { display: none !important; }

        /* DEBUG STYLES */
        #debug-trigger {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9998;
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid #444;
            color: #fff;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(5px);
            transition: transform 0.1s;
        }
        #debug-trigger:active { transform: scale(0.9); }

        #debug-overlay {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 280px;
            background: rgba(5, 5, 5, 0.95);
            border: 1px solid #333;
            color: #0f0;
            font-family: monospace;
            font-size: 11px;
            padding: 12px;
            z-index: 9999;
            border-radius: 10px;
            display: none; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.8);
        }
        
        #debug-logs {
            white-space: pre-wrap;
            max-height: 150px;
            overflow-y: auto;
            border-top: 1px solid #333;
            margin-top: 8px;
            padding-top: 8px;
        }

        /* ALBUM ART ROTATION */
        .album-spin { animation: spin 10s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-white h-screen w-full flex bg-zinc-950 relative overflow-hidden">

    <button id="debug-trigger" onclick="toggleDebug()">
        <i data-lucide="bug" class="w-5 h-5 text-yellow-500"></i>
    </button>
    <div id="debug-overlay">
        <div class="flex justify-between items-center mb-1">
            <span class="font-bold text-white">SYSTEM DIAGNOSTICS</span>
            <button onclick="toggleDebug()" class="text-red-500 font-bold hover:text-red-400 px-2">✕</button>
        </div>
        <div class="text-xs text-zinc-500 mb-1">Status Monitor</div>
        <div id="debug-logs">Waiting for input...</div>
    </div>

    <div class="absolute inset-0 scanlines pointer-events-none z-[60]"></div>

    <div id="sport-intro" class="fixed inset-0 z-[100] flex flex-col items-center justify-center pointer-events-none hidden-force w-full overflow-hidden bg-black">
        <div class="text-center space-y-4 relative z-10 w-full px-4">
            <h1 id="intro-text" class="text-[15vw] leading-none font-black italic text-white font-fl5 tracking-tighter">FULL SEND</h1>
            <div class="text-xl md:text-3xl font-bold bg-white text-black px-6 py-2 skew-x-[-12deg] inline-block uppercase tracking-[0.3em]">
                +R MODE ACTIVE
            </div>
        </div>
    </div>

    <div id="view-eco" class="absolute inset-0 flex z-10 transition-all duration-500 bg-zinc-950">
        <div class="w-20 h-full bg-zinc-950 border-r border-zinc-900 flex flex-col items-center py-6 justify-between z-50 shadow-2xl shrink-0 relative">
            <div class="space-y-10 flex flex-col items-center">
                <div class="p-3 bg-zinc-900 rounded-xl border border-zinc-800">
                    <div class="text-xl font-black tracking-tighter italic text-zinc-500">H</div>
                </div>
                <i data-lucide="map-pin" class="text-zinc-500 w-6 h-6"></i>
                <i data-lucide="gauge" class="text-white w-6 h-6"></i>
                <div class="w-10 h-px bg-zinc-800"></div>
                <i data-lucide="settings-2" class="text-zinc-500 w-6 h-6"></i>
            </div>
            <div id="clock" class="text-xs text-zinc-600 font-bold font-mono">12:00</div>
        </div>

        <div class="flex-1 relative overflow-hidden flex flex-col">
            
            <div class="relative z-30 flex justify-between items-start p-6">
                <div class="flex flex-col gap-6">
                    
                    <div>
                        <div class="flex items-center gap-2 text-zinc-500 mb-1">
                            <i data-lucide="map-pin" class="w-3 h-3"></i>
                            <span id="weather-location" class="text-xs uppercase tracking-widest font-bold text-zinc-400 truncate max-w-[200px]">...</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2">
                                 <i id="weather-icon" data-lucide="cloud" class="w-5 h-5 text-zinc-400"></i>
                                 <span id="weather-temp" class="text-2xl font-bold text-white leading-none">--°</span>
                            </div>
                            <div class="w-px h-6 bg-zinc-800"></div>
                            <div class="flex items-center gap-2">
                                 <div id="eco-status-dot" class="w-2 h-2 rounded-full bg-zinc-600"></div>
                                 <span id="eco-status-text" class="text-xs font-bold text-zinc-500 tracking-wide">NO GPS</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-3 bg-zinc-900/80 p-2 pr-4 rounded-lg border border-zinc-800/50 backdrop-blur-md transition-all hover:border-[#1ed760]/50 group cursor-pointer" onclick="handleSpotifyClick()">
                        
                        <div id="spotify-art-container" class="w-10 h-10 rounded overflow-hidden relative bg-black flex items-center justify-center shrink-0">
                            <img id="spotify-art" src="" class="w-full h-full object-cover hidden">
                            <i id="spotify-icon" data-lucide="music" class="text-white w-5 h-5"></i>
                        </div>

                        <div class="flex flex-col min-w-[120px]">
                            <span id="spotify-title" class="text-[10px] uppercase text-zinc-500 font-bold tracking-wider truncate max-w-[150px]">SPOTIFY</span>
                            <span id="spotify-artist" class="text-xs text-white font-bold tracking-wide truncate max-w-[150px]">Not Connected</span>
                        </div>

                        <div id="spotify-bars" class="flex gap-1 items-end h-4 ml-2 opacity-50 group-hover:opacity-100 transition-opacity">
                            <div class="music-bar"></div>
                            <div class="music-bar"></div>
                            <div class="music-bar"></div>
                            <div class="music-bar"></div>
                        </div>
                    </div>

                </div>

                <div class="flex bg-zinc-900 p-1 rounded-lg border border-zinc-800 shadow-lg">
                    <button class="px-6 py-1 rounded-md text-sm font-bold uppercase tracking-wider transition-all bg-emerald-900/50 text-emerald-400 border border-emerald-500/30 cursor-default">Drive</button>
                    <button onclick="setMode('sport')" class="px-6 py-1 rounded-md text-sm font-bold uppercase tracking-wider transition-all text-zinc-500 hover:text-white hover:bg-zinc-800 relative z-50 cursor-pointer">Sport</button>
                </div>
            </div>

            <div class="relative z-20 flex-1 flex items-center justify-center gap-4 md:gap-8 px-4 pb-12">
                <div class="relative w-48 h-48 md:w-64 md:h-64 flex items-center justify-center">
                    <svg class="w-full h-full transform rotate-[135deg]" viewBox="0 0 200 200">
                        <circle cx="100" cy="100" r="85" fill="none" stroke="#1f2937" stroke-width="12" stroke-dasharray="534" stroke-dashoffset="133.5" />
                        <circle id="eco-ring-rpm" cx="100" cy="100" r="85" fill="none" stroke="#10b981" stroke-width="12" stroke-dasharray="534" stroke-dashoffset="534" class="gauge-transition" />
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center mt-6">
                        <span id="eco-val-rpm" class="text-4xl md:text-6xl font-bold tracking-tighter text-white">0.0</span>
                        <span class="text-zinc-600 text-[10px] md:text-xs uppercase tracking-[0.3em] mt-2">x1000</span>
                    </div>
                </div>

                <div class="flex flex-col items-center w-48 md:w-64 space-y-6 relative">
                    <div class="flex flex-col items-center">
                        <span id="eco-speed-val" class="text-6xl md:text-8xl font-bold text-white tracking-tighter" style="font-family: 'Orbitron', sans-serif;">0</span>
                        <span class="text-zinc-500 text-xs uppercase tracking-[0.4em]">KM/H</span>
                    </div>
                    <div class="relative group">
                        <div class="w-20 h-20 md:w-24 md:h-24 bg-zinc-900 rounded-xl border border-zinc-800 flex items-center justify-center shadow-2xl">
                            <span id="eco-gear-val" class="text-4xl md:text-5xl font-bold text-white">P</span>
                        </div>
                    </div>
                    <button onclick="toggleGPS()" id="btn-gps-eco" class="w-full py-3 rounded bg-zinc-900 border border-zinc-800 text-zinc-400 font-bold text-xs uppercase tracking-[0.2em] transition-all hover:bg-zinc-800 hover:text-white flex items-center justify-center gap-2 cursor-pointer z-50">
                        <i data-lucide="satellite" class="w-3 h-3"></i> Enable GPS
                    </button>
                </div>

                <div class="relative w-48 h-48 md:w-64 md:h-64 flex items-center justify-center">
                    <svg class="w-full h-full transform rotate-[135deg]" viewBox="0 0 200 200">
                        <circle cx="100" cy="100" r="85" fill="none" stroke="#1f2937" stroke-width="12" stroke-dasharray="534" stroke-dashoffset="133.5" />
                        <circle id="eco-ring-speed" cx="100" cy="100" r="85" fill="none" stroke="#10b981" stroke-width="12" stroke-dasharray="534" stroke-dashoffset="534" class="gauge-transition" />
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center mt-6">
                        <span class="text-zinc-600 text-[10px] md:text-xs uppercase tracking-[0.2em]">Eco Guide</span>
                        <div class="w-4 h-4 md:w-6 md:h-6 rounded-full bg-emerald-500 mt-2 shadow-[0_0_15px_#10b981] animate-pulse"></div>
                    </div>
                </div>
            </div>
            <div class="h-1 w-full bg-emerald-500 shadow-[0_0_20px_rgba(16,185,129,0.6)] mt-auto"></div>
        </div>
    </div>

    <div id="view-sport" class="absolute inset-0 z-20 opacity-0 pointer-events-none bg-black flex flex-col transition-opacity duration-500">
        <div class="absolute inset-0 bg-fl5-pattern opacity-0 z-0" id="bg-sport-pattern" style="opacity: 0.5; clip-path: circle(0% at 50% 50%);">
            <div class="absolute inset-0 bg-gradient-to-t from-red-900/20 via-transparent to-transparent"></div>
        </div>
        <div class="absolute top-6 right-6 z-[60] flex gap-3 opacity-0 transition-opacity duration-500" id="sport-buttons">
              <button onclick="toggleGPS()" class="px-4 py-2 bg-zinc-900/80 border border-zinc-700 text-zinc-400 text-xs font-bold uppercase rounded hover:text-blue-400 transition-colors flex items-center gap-2 backdrop-blur-sm cursor-pointer">
                <div id="sport-gps-dot" class="w-2 h-2 rounded-full bg-zinc-600"></div>
                <span id="sport-gps-text">GPS</span>
              </button>
              <button onclick="startNeedleSwipe()" class="px-4 py-2 bg-zinc-900/80 border border-zinc-700 text-zinc-400 text-xs font-bold uppercase rounded hover:bg-yellow-600 hover:text-black hover:border-yellow-500 transition-colors cursor-pointer backdrop-blur-sm active:scale-95">
                Swipe
              </button>
              <button onclick="setMode('eco')" class="px-4 py-2 bg-zinc-900/80 border border-zinc-700 text-zinc-400 text-xs font-bold uppercase rounded hover:bg-red-900/50 hover:text-white hover:border-red-500/50 transition-colors cursor-pointer backdrop-blur-sm active:scale-95">
                Exit +R
              </button>
        </div>
        <div class="flex-1 flex flex-col items-center justify-center w-full max-w-7xl mx-auto relative z-20">
            <div id="sport-rpm-group" class="w-full max-w-5xl mx-auto mb-4 mt-16 opacity-0 transition-opacity duration-300">
                <div class="flex gap-1 mb-1 px-[5%] h-3 justify-center">
                    <div class="led green" id="led-1"></div><div class="led green" id="led-2"></div><div class="led green" id="led-3"></div><div class="led green" id="led-4"></div><div class="led green" id="led-5"></div>
                    <div class="led yellow" id="led-6"></div><div class="led yellow" id="led-7"></div><div class="led yellow" id="led-8"></div>
                    <div class="led red" id="led-9"></div><div class="led red" id="led-10"></div>
                </div>
                <div class="relative w-full h-16 md:h-24">
                    <svg class="w-full h-full overflow-visible" viewBox="0 0 800 100" preserveAspectRatio="none">
                        <defs>
                            <linearGradient id="rpmGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#eab308;stop-opacity:1" />
                                <stop offset="70%" style="stop-color:#eab308;stop-opacity:1" />
                                <stop offset="85%" style="stop-color:#ef4444;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#ef4444;stop-opacity:1" />
                            </linearGradient>
                            <clipPath id="rpmClip"><rect id="rpm-fill-rect" x="0" y="0" width="0" height="100" /></clipPath>
                        </defs>
                        <path d="M 0 90 L 150 15 L 800 15" fill="none" stroke="#262626" stroke-width="12" stroke-linecap="butt" />
                        <g stroke="#555" stroke-width="2">
                            <line x1="150" y1="15" x2="150" y2="35" /><line x1="231" y1="15" x2="231" y2="35" /><line x1="312" y1="15" x2="312" y2="35" /><line x1="393" y1="15" x2="393" y2="35" />
                            <line x1="474" y1="15" x2="474" y2="35" /><line x1="555" y1="15" x2="555" y2="35" /><line x1="636" y1="15" x2="636" y2="35" stroke="#ef4444" /><line x1="717" y1="15" x2="717" y2="35" stroke="#ef4444" />
                        </g>
                        <path d="M 0 90 L 150 15 L 800 15" fill="none" stroke="url(#rpmGradient)" stroke-width="12" stroke-linecap="butt" clip-path="url(#rpmClip)" filter="drop-shadow(0 0 8px rgba(234,179,8,0.6))" />
                    </svg>
                    <div class="absolute top-8 left-0 w-full flex justify-between px-[18%] text-xs md:text-sm font-bold text-zinc-500 font-fl5">
                        <span>0</span><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span class="text-red-500">6</span><span class="text-red-500">7</span>
                    </div>
                    <div class="absolute top-0 right-0 text-white font-mono text-[10px]">x1000 r/min</div>
                </div>
            </div>
            <div class="flex flex-1 w-full items-center justify-center max-w-6xl px-8">
                <div id="sport-misc-group-1" class="flex-1 hidden md:flex flex-col items-end pr-12 border-r border-zinc-900 opacity-0 transition-opacity duration-500">
                    <div class="flex items-center gap-2 mb-1 text-zinc-500">
                        <span id="timer-mode-label" class="text-xs font-bold uppercase tracking-wider">CHRONO</span>
                    </div>
                    <div id="stopwatch-display" class="text-4xl font-fl5 text-white font-mono tabular-nums">00:00.00</div>
                    <div id="manual-controls" class="flex gap-2 mt-2">
                        <button onclick="timerLapReset()" id="btn-lap" class="px-3 py-1 bg-zinc-800 hover:bg-zinc-700 text-[10px] font-bold text-zinc-300 rounded uppercase transition-colors">Reset</button>
                        <button onclick="timerStartStop()" id="btn-start" class="px-3 py-1 bg-emerald-900 hover:bg-emerald-700 text-[10px] font-bold text-emerald-300 rounded uppercase transition-colors">Start</button>
                    </div>
                    <div class="mt-3">
                        <button onclick="activateZeroHundred()" id="btn-zero-hundred" class="w-full px-3 py-1 bg-zinc-900 border border-red-900/50 hover:bg-red-900/20 hover:border-red-500 text-[10px] font-bold text-red-500 rounded uppercase transition-colors tracking-widest flex items-center justify-center gap-1">
                            <i data-lucide="gauge-circle" class="w-3 h-3"></i> 0-100 LAUNCH
                        </button>
                    </div>
                    <div id="auto-controls" class="mt-2 text-[10px] font-bold text-zinc-600 hidden text-right flex flex-col gap-2 items-end">
                        <span id="auto-status">STOP TO ARM</span>
                        <button onclick="cancelZeroHundred()" class="px-2 py-1 bg-red-900/30 border border-red-500 text-red-400 text-[10px] font-bold uppercase rounded hover:bg-red-900/60 transition-colors w-auto">CANCEL</button>
                    </div>
                    <div id="last-lap" class="mt-2 text-[10px] font-mono text-zinc-400">LAST: --:--.--</div>
                </div>
                <div id="sport-speed-group" class="w-80 flex flex-col items-center relative opacity-0 transition-opacity duration-500">
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-48 bg-gradient-to-b from-red-600 to-transparent opacity-30 blur-3xl rounded-full"></div>
                    <span id="sport-speed" class="text-8xl md:text-9xl font-fl5 font-black text-white drop-shadow-lg relative z-10 leading-none">0</span>
                    <span class="text-sm font-bold text-red-500 tracking-[0.4em] relative z-10 -mt-2">KM/H</span>
                    <div class="grid grid-cols-2 gap-x-12 gap-y-2 mt-8 w-full px-4">
                        <div class="flex justify-between items-center text-sm"><span class="text-zinc-500 font-bold">WAT</span> <span class="font-fl5 font-bold text-white">90<span class="text-zinc-600 text-xs">°</span></span></div>
                        <div class="flex justify-between items-center text-sm"><span class="text-zinc-500 font-bold">OIL</span> <span class="font-fl5 font-bold text-white">102<span class="text-zinc-600 text-xs">°</span></span></div>
                        <div class="flex justify-between items-center text-sm"><span class="text-zinc-500 font-bold">BST</span> <span class="font-fl5 font-bold text-white">0.8<span class="text-zinc-600 text-xs">b</span></span></div>
                        <div class="flex justify-between items-center text-sm"><span class="text-zinc-500 font-bold">VLT</span> <span class="font-fl5 font-bold text-white">14.2<span class="text-zinc-600 text-xs">v</span></span></div>
                    </div>
                </div>
                <div id="sport-misc-group-2" class="flex-1 flex flex-col items-start pl-12 border-l border-zinc-900 opacity-0 transition-opacity duration-500">
                    <div class="flex items-baseline gap-2 mb-6">
                        <span class="text-red-600 font-black italic text-2xl font-fl5 mr-2">+R</span>
                        <span id="sport-gear" class="text-7xl font-fl5 font-black text-white tracking-tighter">N</span>
                    </div>
                    <div class="relative w-32 h-32 border-2 border-zinc-800 rounded-full flex items-center justify-center bg-zinc-900/50">
                        <div class="absolute w-20 h-20 border border-zinc-800 rounded-full"></div>
                        <div class="absolute w-full h-[1px] bg-zinc-800"></div>
                        <div class="absolute h-full w-[1px] bg-zinc-800"></div>
                        <div id="g-ghost" class="w-2 h-2 bg-red-900/50 rounded-full absolute transition-all duration-1000 opacity-0"></div>
                        <div id="g-dot" class="w-3 h-3 bg-yellow-400 rounded-full shadow-[0_0_10px_#facc15] g-dot-smooth relative z-10"></div>
                        <span class="absolute bottom-2 text-[8px] text-zinc-500 font-bold">PEAK G</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // =================================================================
        // !!! USER CONFIGURATION !!!
        // =================================================================
        // Leave empty for Visualizer Mode. 
        // Add your ID for Real Data.
        const SPOTIFY_CLIENT_ID = '852950465a424a9fb4f2cb105a5089a5'; 
        // =================================================================

        // --- SPOTIFY LOGIC ---
        const SPOTIFY_AUTH_ENDPOINT = 'https://accounts.spotify.com/authorize';
        const SPOTIFY_SCOPES = ['user-read-currently-playing', 'user-read-playback-state'];

        // Auto-detect your Netlify URL for the Redirect URI
        const REDIRECT_URI = window.location.origin + window.location.pathname;

        let spotifyToken = null;
        let spotifyInterval = null;

        function handleSpotifyClick() {
            if (!SPOTIFY_CLIENT_ID) {
                alert("Visualizer Mode Active.\nTo get Real Data, edit the code and add your Spotify Client ID.");
                return;
            }
            if (!spotifyToken) {
                // Start Login
                const authUrl = `${SPOTIFY_AUTH_ENDPOINT}?client_id=${SPOTIFY_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SPOTIFY_SCOPES.join(' '))}&response_type=token&show_dialog=true`;
                window.location.href = authUrl;
            }
        }

        function checkSpotifyAuth() {
            // 1. Check URL Hash for token (returning from login)
            const hash = window.location.hash;
            if (hash && hash.includes('access_token')) {
                const token = new URLSearchParams(hash.substring(1)).get('access_token');
                if (token) {
                    spotifyToken = token;
                    localStorage.setItem('sp_token', token);
                    window.location.hash = ''; // Clean URL
                    debugLog("Spotify Connected!");
                    startSpotifyPolling();
                }
            } 
            // 2. Check LocalStorage (refresh)
            else {
                const stored = localStorage.getItem('sp_token');
                if (stored) {
                    spotifyToken = stored;
                    debugLog("Spotify Restored");
                    startSpotifyPolling();
                }
            }
        }

        function startSpotifyPolling() {
            if(spotifyInterval) clearInterval(spotifyInterval);
            updateSpotifyUI(); // Immediate check
            spotifyInterval = setInterval(updateSpotifyUI, 5000); // Check every 5s
        }

        async function updateSpotifyUI() {
            if (!spotifyToken) return;

            try {
                const res = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
                    headers: { 'Authorization': `Bearer ${spotifyToken}` }
                });

                if (res.status === 204 || res.status > 400) {
                    // Nothing playing or Error
                    if(res.status === 401) {
                        debugLog("Spotify Token Expired");
                        spotifyToken = null;
                        localStorage.removeItem('sp_token');
                        document.getElementById('spotify-artist').innerText = "Re-Login Required";
                    }
                    return; 
                }

                const data = await res.json();
                if (data && data.item) {
                    // Update Text
                    document.getElementById('spotify-title').innerText = "NOW PLAYING";
                    document.getElementById('spotify-artist').innerText = data.item.name + " • " + data.item.artists[0].name;
                    
                    // Update Art
                    const artUrl = data.item.album.images[0].url;
                    const artImg = document.getElementById('spotify-art');
                    const icon = document.getElementById('spotify-icon');
                    
                    artImg.src = artUrl;
                    artImg.classList.remove('hidden');
                    icon.classList.add('hidden');
                }
            } catch (e) {
                // Silent fail
            }
        }

        // --- DEBUG LOGIC ---
        function toggleDebug() {
            const overlay = document.getElementById('debug-overlay');
            const trigger = document.getElementById('debug-trigger');
            
            if (overlay.style.display === 'block') {
                overlay.style.display = 'none';
                trigger.style.display = 'flex';
            } else {
                overlay.style.display = 'block';
                trigger.style.display = 'none';
            }
        }

        function debugLog(msg) {
            const container = document.getElementById('debug-logs');
            container.innerHTML = `<div>> ${msg}</div>` + container.innerHTML;
            const lines = container.children;
            if (lines.length > 15) container.removeChild(lines[lines.length - 1]);
            console.log(msg);
        }

        window.onerror = function(msg, url, line) {
            const err = `FATAL: ${msg} \nLine: ${line}`;
            debugLog(err);
            return false;
        };

        // --- APP STATE & GPS ---
        const AppState = {
            mode: 'eco',
            gpsActive: false,
            watchId: null,
            lastLat: null, lastLon: null, lastTime: null,
            simulatedRPM: 0,
            swiping: false,
            timerMode: 'manual', 
            swRunning: false,
            swStartTime: 0,
            swElapsed: 0,
            swInterval: null,
            autoArmed: false,
            autoRunning: false,
            lastWeatherUpdate: 0,
            lastWeatherPos: { lat: 0, lon: 0 }
        };
        
        const SHIFT_RPM_START = 4000;

        async function updateWeather(lat, lon) {
            const now = Date.now();
            const dist = getDistanceFromLatLonInKm(AppState.lastWeatherPos.lat, AppState.lastWeatherPos.lon, lat, lon);
            if (dist < 1 && (now - AppState.lastWeatherUpdate) < 300000) return;
            AppState.lastWeatherUpdate = now;
            AppState.lastWeatherPos = { lat, lon };

            try {
                const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code`);
                const wData = await wRes.json();
                if (wData.current) {
                    const temp = Math.round(wData.current.temperature_2m);
                    document.getElementById('weather-temp').innerText = `${temp}°`;
                    const code = wData.current.weather_code;
                    const iconEl = document.getElementById('weather-icon');
                    iconEl.innerHTML = '';
                    let iconName = 'cloud';
                    if(code <= 1) iconName = 'sun';
                    else if(code <= 3) iconName = 'cloud-sun';
                    else if(code <= 67) iconName = 'cloud-rain';
                    else if(code <= 77) iconName = 'snowflake';
                    else if(code > 90) iconName = 'cloud-lightning';
                    iconEl.setAttribute('data-lucide', iconName);
                    lucide.createIcons();
                }
            } catch (e) { debugLog("Weather Error: " + e.message); }

            try {
                const lRes = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);
                const lData = await lRes.json();
                const city = lData.locality || lData.city || lData.principalSubdivision || "Unknown";
                document.getElementById('weather-location').innerText = city.toUpperCase();
            } catch (e) { debugLog("Loc Error: " + e.message); }
        }

        function setMode(mode) {
            if (AppState.mode === mode) return;
            AppState.mode = mode;
            const ecoView = document.getElementById('view-eco');
            const sportView = document.getElementById('view-sport');
            const intro = document.getElementById('sport-intro');
            const introText = document.getElementById('intro-text');
            const bgSport = document.getElementById('bg-sport-pattern');
            const rpmGroup = document.getElementById('sport-rpm-group');
            const speedGroup = document.getElementById('sport-speed-group');
            const misc1 = document.getElementById('sport-misc-group-1');
            const misc2 = document.getElementById('sport-misc-group-2');
            const btns = document.getElementById('sport-buttons');

            if (mode === 'sport') {
                ecoView.style.opacity = '0';
                ecoView.style.pointerEvents = 'none';
                intro.classList.remove('hidden-force');
                introText.classList.add('anim-text-strobe');
                sportView.classList.remove('pointer-events-none');
                sportView.style.opacity = '1'; 
                rpmGroup.style.opacity = '0';
                speedGroup.style.opacity = '0';
                misc1.style.opacity = '0';
                misc2.style.opacity = '0';
                btns.style.opacity = '0';
                bgSport.style.opacity = '0.5'; 
                bgSport.classList.remove('anim-bg-reveal'); 
                bgSport.style.clipPath = 'circle(0% at 50% 50%)'; 

                setTimeout(() => {
                    introText.classList.remove('anim-text-strobe');
                    intro.classList.add('hidden-force'); 
                    rpmGroup.style.opacity = '1'; 
                    startNeedleSwipe();
                }, 800);
                setTimeout(() => { speedGroup.style.opacity = '1'; }, 1600);
                setTimeout(() => {
                    misc1.style.opacity = '1';
                    misc2.style.opacity = '1';
                    btns.style.opacity = '1';
                    bgSport.style.clipPath = ''; 
                    bgSport.classList.add('anim-bg-reveal'); 
                }, 2100);
            } else {
                sportView.style.opacity = '0';
                sportView.classList.add('pointer-events-none');
                bgSport.classList.remove('anim-bg-reveal');
                ecoView.style.opacity = '1';
                ecoView.style.transform = 'scale(1)';
                ecoView.classList.add('anim-eco-enter');
                ecoView.style.pointerEvents = 'auto';
                setTimeout(() => ecoView.classList.remove('anim-eco-enter'), 1000);
            }
        }

        function startNeedleSwipe() {
            if (AppState.swiping) return;
            AppState.swiping = true;
            const duration = 1500; 
            const startTime = Date.now();
            function swipeFrame() {
                const now = Date.now();
                const elapsed = now - startTime;
                const progress = Math.min(elapsed / duration, 1);
                let val = 0;
                if(progress < 0.5) val = progress * 2; 
                else val = 2 - (progress * 2); 
                val = Math.max(0, val); 
                const swipeRpm = val * 8000;
                const rpmPct = swipeRpm / 7500; 
                document.getElementById('rpm-fill-rect').setAttribute('width', Math.min(rpmPct, 1.07) * 800);
                if(document.getElementById('sport-speed-group').style.opacity === '1') {
                    document.getElementById('sport-speed').innerText = Math.round(val * 188);
                }
                updateShiftLights(swipeRpm);
                if(progress < 1) {
                    requestAnimationFrame(swipeFrame);
                } else {
                    AppState.swiping = false;
                    document.getElementById('sport-speed').innerText = "0"; 
                    updateDisplay(0); 
                }
            }
            requestAnimationFrame(swipeFrame);
        }

        function updateDisplay(speedKmh) {
            if(AppState.swiping) return;
            const roundedSpeed = Math.round(speedKmh);

            if (AppState.timerMode === 'auto') {
                if (speedKmh < 2 && !AppState.autoRunning) {
                    AppState.autoArmed = true;
                    document.getElementById('auto-status').innerHTML = "READY<br>LAUNCH";
                    document.getElementById('auto-status').className = "mt-2 text-[10px] font-bold text-emerald-500 animate-pulse text-right leading-tight";
                    if(!AppState.autoRunning) document.getElementById('stopwatch-display').innerText = "00:00.00";
                } else if (AppState.autoArmed && speedKmh >= 2 && !AppState.autoRunning) {
                    AppState.autoArmed = false;
                    AppState.autoRunning = true;
                    AppState.swStartTime = Date.now();
                    document.getElementById('auto-status').innerText = "GO GO GO";
                    document.getElementById('auto-status').className = "mt-2 text-[10px] font-bold text-red-500 text-right";
                    AppState.swInterval = setInterval(() => {
                        const now = Date.now();
                        const diff = now - AppState.swStartTime;
                        formatTime(diff);
                    }, 30);
                } else if (AppState.autoRunning && speedKmh >= 100) {
                    clearInterval(AppState.swInterval);
                    AppState.autoRunning = false;
                    const finalTime = Date.now() - AppState.swStartTime;
                    formatTime(finalTime);
                    document.getElementById('last-lap').innerText = "0-100: " + document.getElementById('stopwatch-display').innerText;
                    document.getElementById('auto-status').innerText = "FINISHED";
                    document.getElementById('auto-status').className = "mt-2 text-[10px] font-bold text-emerald-400 text-right";
                }
            }

            let gear = 'N';
            if (speedKmh > 1) {
                if (speedKmh < 20) gear = '1';
                else if (speedKmh < 40) gear = '2';
                else if (speedKmh < 65) gear = '3';
                else if (speedKmh < 90) gear = '4';
                else if (speedKmh < 120) gear = '5';
                else gear = '6';
            }
            
            let rpm = 800; 
            if (speedKmh > 1) {
                let gearRange = 40; 
                let positionInGear = (speedKmh % gearRange) / gearRange; 
                rpm = 2000 + (positionInGear * 5000) + (Math.random() * 100 - 50);
            }

            if (AppState.mode === 'eco') {
                document.getElementById('eco-speed-val').innerText = roundedSpeed;
                document.getElementById('eco-gear-val').innerText = (speedKmh < 1 ? 'P' : 'D');
                const maxRpm = 8000;
                const circumference = 534; 
                const arcLength = circumference * 0.75; 
                const baseOffset = circumference * 0.25;
                const rpmOffset = baseOffset + (arcLength - (Math.min(rpm, maxRpm) / maxRpm) * arcLength);
                document.getElementById('eco-ring-rpm').style.strokeDashoffset = rpmOffset;
                document.getElementById('eco-val-rpm').innerText = (rpm / 1000).toFixed(1);
                const speedOffset = baseOffset + (arcLength - (Math.min(speedKmh, 200) / 200) * arcLength);
                document.getElementById('eco-ring-speed').style.strokeDashoffset = speedOffset;
            }

            if (AppState.mode === 'sport') {
                document.getElementById('sport-speed').innerText = roundedSpeed;
                document.getElementById('sport-gear').innerText = gear;
                const rpmPct = Math.min(rpm, 7500) / 7500;
                document.getElementById('rpm-fill-rect').setAttribute('width', rpmPct * 800);
                updateShiftLights(rpm);
                if(speedKmh > 5) {
                    const moveX = (Math.random() * 60) - 30;
                    const moveY = (Math.random() * 60) - 30;
                    document.getElementById('g-dot').style.transform = `translate(${moveX}px, ${moveY}px)`;
                } else {
                    document.getElementById('g-dot').style.transform = `translate(0px, 0px)`;
                }
            }
        }

        function activateZeroHundred() {
            AppState.timerMode = 'auto';
            document.getElementById('timer-mode-label').innerText = "AUTO 0-100";
            document.getElementById('manual-controls').classList.add('hidden');
            document.getElementById('btn-zero-hundred').classList.add('hidden'); 
            document.getElementById('auto-controls').classList.remove('hidden');
            clearInterval(AppState.swInterval);
            AppState.swRunning = false;
            AppState.autoRunning = false;
            AppState.autoArmed = true; 
            document.getElementById('stopwatch-display').innerText = "00:00.00";
            updateDisplay(0); 
        }

        function cancelZeroHundred() {
            clearInterval(AppState.swInterval);
            AppState.swRunning = false;
            AppState.autoRunning = false;
            AppState.autoArmed = false;
            toggleTimerMode(); 
        }

        function toggleTimerMode() {
            AppState.timerMode = 'manual';
            document.getElementById('timer-mode-label').innerText = "STOPWATCH";
            document.getElementById('manual-controls').classList.remove('hidden');
            document.getElementById('btn-zero-hundred').classList.remove('hidden');
            document.getElementById('auto-controls').classList.add('hidden');
            AppState.autoArmed = false;
        }

        function timerStartStop() {
            const btn = document.getElementById('btn-start');
            const lapBtn = document.getElementById('btn-lap');
            if (!AppState.swRunning) {
                AppState.swRunning = true;
                AppState.swStartTime = Date.now() - AppState.swElapsed;
                AppState.swInterval = setInterval(() => {
                    AppState.swElapsed = Date.now() - AppState.swStartTime;
                    formatTime(AppState.swElapsed);
                }, 30);
                btn.innerText = "STOP";
                btn.className = "px-3 py-1 bg-red-900 hover:bg-red-700 text-[10px] font-bold text-red-300 rounded uppercase transition-colors";
                lapBtn.innerText = "LAP";
            } else {
                AppState.swRunning = false;
                clearInterval(AppState.swInterval);
                btn.innerText = "START";
                btn.className = "px-3 py-1 bg-emerald-900 hover:bg-emerald-700 text-[10px] font-bold text-emerald-300 rounded uppercase transition-colors";
                lapBtn.innerText = "RESET";
            }
        }

        function timerLapReset() {
            const lapBtn = document.getElementById('btn-lap');
            if (AppState.swRunning) {
                const current = document.getElementById('stopwatch-display').innerText;
                document.getElementById('last-lap').innerText = "LAP: " + current;
            } else {
                AppState.swElapsed = 0;
                document.getElementById('stopwatch-display').innerText = "00:00.00";
                document.getElementById('last-lap').innerText = "LAST: --:--.--";
            }
        }

        function formatTime(ms) {
            const m = Math.floor(ms / 60000).toString().padStart(2, '0');
            const s = Math.floor((ms % 60000) / 1000).toString().padStart(2, '0');
            const cs = Math.floor((ms % 1000) / 10).toString().padStart(2, '0');
            document.getElementById('stopwatch-display').innerText = `${m}:${s}.${cs}`;
        }

        function updateShiftLights(rpm) {
            const leds = document.querySelectorAll('.led');
            leds.forEach(l => l.classList.remove('on', 'blink'));
            if (rpm >= SHIFT_RPM_START) {
                const activeCount = Math.floor((rpm - SHIFT_RPM_START) / 300);
                for(let i=0; i <= Math.min(activeCount, 9); i++) {
                    if(leds[i]) leds[i].classList.add('on');
                }
                if(rpm > 6800) leds.forEach(l => l.classList.add('blink'));
            }
        }

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; 
            var dLat = deg2rad(lat2-lat1);
            var dLon = deg2rad(lon2-lon1); 
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            return R * c; 
        }
        function deg2rad(deg) { return deg * (Math.PI/180); }

        function toggleGPS() {
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                alert("iOS RESTRICTION: Use HTTPS (Netlify/Vercel).");
                return;
            }
            const btnEco = document.getElementById('btn-gps-eco');
            const btnSportText = document.getElementById('sport-gps-text');
            const dotEco = document.getElementById('eco-status-dot');
            const txtEco = document.getElementById('eco-status-text');
            const dotSport = document.getElementById('sport-gps-dot');
            if (AppState.gpsActive) {
                if (AppState.watchId) navigator.geolocation.clearWatch(AppState.watchId);
                AppState.gpsActive = false;
                dotEco.className = "w-2 h-2 rounded-full bg-zinc-600";
                txtEco.innerText = "GPS PAUSED";
                btnEco.innerHTML = '<i data-lucide="satellite" class="w-3 h-3"></i> Enable GPS';
                dotSport.className = "w-2 h-2 rounded-full bg-zinc-600";
                if(btnSportText) btnSportText.innerText = "GPS";
                debugLog("GPS: Stopped by user");
                updateDisplay(0);
            } else {
                if (!("geolocation" in navigator)) {
                    alert("GPS not supported.");
                    return;
                }
                dotEco.className = "w-2 h-2 rounded-full bg-yellow-500 animate-pulse";
                txtEco.innerText = "SEARCHING...";
                btnEco.innerHTML = '<i data-lucide="satellite" class="w-3 h-3"></i> Stop GPS';
                dotSport.className = "w-2 h-2 rounded-full bg-yellow-500 animate-pulse";
                if(btnSportText) btnSportText.innerText = "SEARCH";
                AppState.gpsActive = true;
                debugLog("GPS: Requesting High Accuracy...");
                const optionsHigh = { 
                    enableHighAccuracy: true, 
                    timeout: 20000, 
                    maximumAge: 0 
                };
                AppState.watchId = navigator.geolocation.watchPosition(handleSuccess, handleError, optionsHigh);
                lucide.createIcons();
            }
        }

        function handleSuccess(position) {
            document.getElementById('eco-status-dot').className = "w-2 h-2 rounded-full bg-emerald-500 animate-pulse";
            document.getElementById('eco-status-text').innerText = "GPS LOCKED";
            document.getElementById('sport-gps-dot').className = "w-2 h-2 rounded-full bg-emerald-500 animate-pulse";
            document.getElementById('sport-gps-text').innerText = "LOCKED";
            let lat = position.coords.latitude;
            let lon = position.coords.longitude;
            let acc = position.coords.accuracy;
            let rawSpd = position.coords.speed;
            debugLog(`GPS OK: Acc=${Math.round(acc)}m | Spd=${rawSpd}`);
            updateWeather(lat, lon);
            let speedMps = rawSpd;
            if (speedMps === null || speedMps < 0.1) {
                const currentTime = position.timestamp;
                if (AppState.lastLat !== null) {
                    const distanceKm = getDistanceFromLatLonInKm(AppState.lastLat, AppState.lastLon, lat, lon);
                    const distanceMeters = distanceKm * 1000;
                    const timeDiffSeconds = (currentTime - AppState.lastTime) / 1000;
                    if (timeDiffSeconds > 0.5 && distanceMeters > 2) {
                        speedMps = distanceMeters / timeDiffSeconds;
                        debugLog(`Calc Speed: ${speedMps.toFixed(1)} m/s`);
                    } else {
                        speedMps = 0;
                    }
                }
                AppState.lastLat = lat;
                AppState.lastLon = lon;
                AppState.lastTime = currentTime;
            }
            let speedKmph = (speedMps || 0) * 3.6;
            if (speedKmph < 2) speedKmph = 0;
            updateDisplay(speedKmph);
        }

        function handleError(error) {
            const txtEco = document.getElementById('eco-status-text');
            debugLog(`GPS ERROR ${error.code}: ${error.message}`);
            if (error.code === 1) {
                 alert("GPS DENIED. Check iPhone Settings > Privacy > Location Services > Safari");
                 toggleGPS();
            } else if (error.code === 3) {
                txtEco.innerText = "WEAK SIG";
                debugLog("Timeout: Switching to Low Accuracy");
                if (AppState.watchId) navigator.geolocation.clearWatch(AppState.watchId);
                AppState.watchId = navigator.geolocation.watchPosition(
                    handleSuccess,
                    (e) => debugLog("Low Acc Fail: " + e.message),
                    { enableHighAccuracy: false, timeout: 20000, maximumAge: 10000 }
                );
            } else if (error.code === 2) {
                txtEco.innerText = "NO SIGNAL";
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setInterval(() => {
                const now = new Date();
                document.getElementById('clock').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }, 1000);
            setMode('eco');
            checkSpotifyAuth(); // NEW
            debugLog("Init Complete");
        });
    </script>
</body>
</html>
